## Поддержка топиков в супергруппах `chatpapp`

### 1. Цели и сценарии
- Разделение больших диалогов на независимые ветки обсуждений (топики), аналогично Telegram Forum Mode.
- Снижение шума: пользователи подписываются на интересующие топики, отключают уведомления для остальных.
- Гибкая модерация: администраторы управляют жизненным циклом топиков и правами участников.

### 2. Модель данных
- `topics`:
  - `id` (UUID), `dialogId`, `title`, `icon`, `status` (`active|closed|archived`), `createdBy`, `createdAt`, `updatedAt`.
  - Дополнительно: `description`, `pinnedMessageId`, `moderators[]`, `slowModeInterval`, `autoDeleteTTL`.
- `messages`:
  - Добавить поле `topicId` (nullable). Сообщения с `topicId = null` относятся к “общему” чату.
  - Индекс `(dialogId, topicId, createdAt)` для быстрой пагинации.
- `topic_read_states`:
  - `userId`, `topicId`, `lastReadMessageId` или `lastReadAt`, `unreadCount`.
  - Индексы по `(userId, topicId)` и TTL для автоочистки архивных топиков.
- Дополнительно при необходимости: `topic_subscriptions` (для явной подписки/мьюта), `topic_events` (аудит действий модераторов).

### 3. Backend-архитектура
- **Контроллеры и маршруты** (`backend/src/controllers/dialogsController.js`, `backend/src/routes/dialogs.js`):
  - CRUD для топиков: `POST /dialogs/:id/topics`, `PATCH /dialogs/:id/topics/:topicId`, `DELETE` (архивация), `POST /reopen`, `POST /close`.
  - Управление подписками: `POST /dialogs/:id/topics/:topicId/subscribe|mute`.
  - Перемещение сообщений: `POST /dialogs/:id/topics/:topicId/move` с перечислением `messageIds`.
  - Получение сообщений топика: `GET /dialogs/:id/topics/:topicId/messages` с пагинацией по `createdAt`/`messageId`.
- **Сервисный слой** (`backend/src/services/Chat3Client.js`, `MessageService`, `TopicService`):
  - Инкапсулирует бизнес-логику: проверка прав, изменение статуса, обновление связей сообщений.
  - Распространяет события в WebSocket-шину (`message.created`, `topic.created`, `topic.updated`, `topic.closed`, `message.moved`).
- **Валидация и авторизация**:
  - Middleware проверяет роли пользователя: глобальный админ, админ диалога, модератор топика, участник.
  - Настраиваемые правила: кто может создавать/закрывать топики, добавление модераторов.

### 4. Реал-тайм и уведомления
- WebSocket-слои (`socket.io` или аналог) создают каналы вида `dialog:{dialogId}:topic:{topicId}`.
- При входе в топик клиент подписывается на канал; при мьюте — отписывается или игнорирует payload.
- Push/Email уведомления фильтруются по `topic_subscriptions`; упоминания и ответы отправляются всегда.
- Для системных событий (создание топика, закрытие) посылается broadcast в общий канал диалога.

### 5. Клиентские изменения
- UI показывает список топиков слева или в отдельной вкладке “Топики”, с бейджами непрочитанных сообщений.
- При выборе топика загрузка его ленты и синхронизация `lastReadMessageId`.
- Компонент отправки сообщения добавляет `topicId` к запросу; дефолт — “Общий чат”.
- Админские действия доступны в выпадающем меню: переименовать, закрепить, включить slow-mode, закрыть.
- Модальные окна для поиска топиков, упорядочивание по активности, фильтры (показать только непрочитанные).

### 6. Поиск и аналитика
- Индексация сообщений учитывает `topicId`, что позволяет строить фильтры “поиск внутри топика” и глобальный поиск с указанием контекста.
- Метрики: количество активных топиков, глубина обсуждений, среднее время жизни, вовлеченность (пользователи с непрочитанными).
- Настроить алерты на “взрыв активности” в топике для модераторов.

### 7. Интеграция с ботами и внешними сервисами
- В webhook-события (`message`, `message:edited`) добавить поле `topicId` / `messageThreadId`.
- Интегрировать в Bot API шлюз аналог Telegram: методы `createTopic`, `editTopic`, `closeTopic`, `sendMessage` с указанием `topicId`.
- При ответе бота на сообщение внутри топика по умолчанию сохраняем контекст ветки.

### 8. Миграция и развёртывание
- Миграции БД: создание таблиц/коллекций, добавление индексов, бэкфилл `topicId = null` для существующих сообщений.
- Фича-флаг на уровне конфигурации, чтобы включать режим топиков по группам.
- Постепенное развёртывание клиентских обновлений: сначала скрытая вкладка, затем публичный релиз.
- Подготовить скрипт архивации старых топиков и политику ретенции.

### 9. Масштабирование и отказоустойчивость
- Разделить хранение сообщений по шардам `(dialogId, topicId)` для равномерной нагрузки.
- Кэшировать метаданные топиков в Redis/MemoryStore; инвалидация через Pub/Sub.
- Использовать отложенные очереди для автоудаления сообщений (TTL) и slow-mode rate limiting.
- Логирование ключевых событий и трассировка (например, OpenTelemetry) для отладки.

### 10. Дальнейшее развитие
- Добавить вложенные под-топики или шаблоны (FAQ, поддержка, объявления).
- Интегрировать реакции, опросы и медиаальбомы внутри топиков.
- Реализовать экспорты/импорт обсуждений и синхронизацию с внешними системами (CRM, helpdesk).
- Расширить аналитику для рекомендательных блоков “Популярные топики” и персональных дайджестов.

