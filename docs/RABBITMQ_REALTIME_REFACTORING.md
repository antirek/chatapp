# RabbitMQ Real-time Refactoring

**–î–∞—Ç–∞**: 05.11.2025  
**–í–µ—Ä—Å–∏—è**: 1.5.0  
**–°—Ç–∞—Ç—É—Å**: üöß –í –†–ê–ó–†–ê–ë–û–¢–ö–ï

---

## –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–í –≤–µ—Ä—Å–∏–∏ 1.4.1 –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ **–ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ Socket.io**:

```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ö–æ—Å—Ç—ã–ª—å
const io = req.app.get('io');
io.emitNewMessage(dialogId, result.data);
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –û–±—Ö–æ–¥–∏—Ç RabbitMQ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Updates –æ—Ç Chat3
- ‚ùå –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è (–æ–¥–∏–Ω backend instance)
- ‚ùå –ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–º–µ—Ç–∞-—Ç–µ–≥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –¥—Ä—É–≥–æ–º—É WebSocket —Å–µ—Ä–≤–µ—Ä—É

---

## –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ RabbitMQ

### –°—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                –ü–†–ê–í–ò–õ–¨–ù–´–ô FLOW                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

User 1 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
         ‚îÇ
         ‚ñº
Backend: POST /api/messages/dialog/:id
         ‚îÇ
         ‚ñº
Chat3 API: createMessage()
         ‚îÇ
         ‚ñº
Chat3 —Å–æ–∑–¥–∞–µ—Ç Event: message.create
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Chat3 Update Worker  ‚îÇ  (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å Chat3)
‚îÇ   (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –î–ª—è –∫–∞–∂–¥–æ–≥–æ member –¥–∏–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–µ—Ç Update
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
Update      Update     Update     Update
User 1      User 2     User 3     User N
    ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  RabbitMQ Exchange: chat3_updates     ‚îÇ
‚îÇ  Type: topic                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
    ‚îÇ routing_key per user:
    ‚îÇ user.usr_xxx.messageupdate
    ‚îÇ user.usr_yyy.messageupdate
    ‚îÇ
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
Queue       Queue      Queue      Queue
user_xxx    user_yyy   user_zzz   user_nnn
    ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
    ‚îÇ (auto-delete, exclusive)
    ‚îÇ
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   WebSocket Server (–Ω–∞—à backend)      ‚îÇ
‚îÇ   - –°–æ–∑–¥–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏   ‚îÇ
‚îÇ   - –°–ª—É—à–∞–µ—Ç updates –∏–∑ –æ—á–µ—Ä–µ–¥–∏        ‚îÇ
‚îÇ   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Socket.io        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
Frontend   Frontend   Frontend   Frontend
  User 1     User 2     User 3     User N
    ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
    ‚îÇ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–∏–∞–ª–æ–≥–æ–º
    ‚îÇ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ updates
    ‚îÇ
    ‚ñº          ‚ñº          ‚ñº          ‚ñº
   UI         UI         UI         UI
  Update    Update     Update     Update
```

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: Backend - RabbitMQ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ

#### 1.1. –£–¥–∞–ª–∏—Ç—å –∫–æ—Å—Ç—ã–ª—å –∏–∑ `routes/messages.js`

```javascript
// ‚ùå –£–î–ê–õ–ò–¢–¨
const io = req.app.get('io');
if (io && io.emitNewMessage) {
  io.emitNewMessage(dialogId, result.data);
}
```

#### 1.2. –°–æ–∑–¥–∞—Ç—å `services/rabbitmqConsumer.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RabbitMQ –æ—á–µ—Ä–µ–¥—è–º–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```javascript
class RabbitMQConsumer {
  constructor() {
    this.connection = null;
    this.channel = null;
    this.userQueues = new Map(); // userId -> queueName
  }

  async connect() {
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ RabbitMQ
  }

  async createUserQueue(userId, socketId) {
    // –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å
    // –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ exchange chat3_updates
    // –°–ª—É—à–∞—Ç—å updates
  }

  async deleteUserQueue(userId) {
    // –£–¥–∞–ª–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
  }
}
```

#### 1.3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `websocket/index.js`

**–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```javascript
socket.on('authenticate', async (userId) => {
  socket.userId = userId;
  
  // ‚úÖ –°–æ–∑–¥–∞—Ç—å RabbitMQ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await rabbitmqConsumer.createUserQueue(userId, socket.id, (update) => {
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å update —á–µ—Ä–µ–∑ WebSocket
    socket.emit('update', update);
  });
});
```

**–ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏:**
```javascript
socket.on('disconnect', async () => {
  // ‚úÖ –£–¥–∞–ª–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
  await rabbitmqConsumer.deleteUserQueue(socket.userId);
});
```

---

### –≠—Ç–∞–ø 2: Frontend - –û–±—Ä–∞–±–æ—Ç–∫–∞ Updates ‚úÖ

#### 2.1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `services/websocket.ts`

**–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ updates:**
```typescript
class WebSocketService {
  connect(token: string) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    // ‚úÖ –°–ª—É—à–∞—Ç—å updates –æ—Ç RabbitMQ
    this.socket.on('update', (update: Update) => {
      this.handleUpdate(update);
    });
  }
  
  private handleUpdate(update: Update) {
    console.log('üì¨ Received update:', update.eventType);
    
    // –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
    switch (update.eventType) {
      case 'message.create':
        this.emit('message:new', update.data);
        break;
      case 'message.update':
        this.emit('message:update', update.data);
        break;
      case 'dialog.update':
        this.emit('dialog:update', update.data);
        break;
      case 'dialog.member.add':
        this.emit('dialog:update', update.data);
        break;
      // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã
    }
  }
}
```

#### 2.2. `ChatView.vue` - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

Frontend —É–∂–µ —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è `message:new`, `dialog:update` –∏ —Ç.–¥. - –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!

```typescript
// ‚úÖ –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
websocket.on('message:new', handleNewMessage);
websocket.on('dialog:update', handleDialogUpdate);
```

---

### –≠—Ç–∞–ø 3: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ ‚úÖ

#### 3.1. –£–¥–∞–ª–∏—Ç—å –∏–∑ `websocket/index.js`

```javascript
// ‚ùå –£–î–ê–õ–ò–¢–¨
io.emitNewMessage = (dialogId, message) => {
  io.to(`dialog:${dialogId}`).emit('message:new', message);
};

// ‚ùå –£–î–ê–õ–ò–¢–¨
socket.on('dialog:join', (dialogId) => {
  socket.join(`dialog:${dialogId}`);
});
```

#### 3.2. –£–¥–∞–ª–∏—Ç—å –∏–∑ `ChatView.vue`

```typescript
// ‚ùå –£–î–ê–õ–ò–¢–¨
websocket.joinDialog(dialog.dialogId);
```

---

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### RabbitMQ –û—á–µ—Ä–µ–¥—å

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—á–µ—Ä–µ–¥–∏:**
```javascript
{
  durable: false,      // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫
  autoDelete: true,    // –£–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
  exclusive: true      // –¢–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ connection
}
```

**Routing Key:**
```
user.{userId}.*
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- `user.usr_qk2ddpnx.messageupdate`
- `user.usr_qk2ddpnx.dialogupdate`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Update –æ—Ç Chat3

```javascript
{
  _id: ObjectId("..."),
  tenantId: "tnt_default",
  userId: "usr_qk2ddpnx",        // –ü–æ–ª—É—á–∞—Ç–µ–ª—å
  dialogId: ObjectId("..."),
  entityId: ObjectId("..."),      // ID Message/Dialog
  eventId: ObjectId("..."),
  eventType: "message.create",    // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
  data: {                         // –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    _id: ObjectId("..."),
    dialogId: ObjectId("..."),
    senderId: "usr_e86m1drv",
    content: "–ü—Ä–∏–≤–µ—Ç!",
    type: "text",
    reactionCounts: {},
    createdAt: "2025-11-05T...",
    meta: {
      channelType: "whatsapp"
    }
  },
  published: true,
  publishedAt: "2025-11-05T...",
  createdAt: "2025-11-05T..."
}
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ WebSocket —Å–µ—Ä–≤–µ—Ä–æ–≤**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç update –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∫ –∫–∞–∫–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –ø–æ–¥–∫–ª—é—á–µ–Ω
- RabbitMQ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É

### ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- –ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç Update —Å **–µ–≥–æ –º–µ—Ç–∞-—Ç–µ–≥–∞–º–∏**
- `dialogMemberMeta` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–ª—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Ç.–¥.

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- Updates —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ MongoDB –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- Manual acknowledgment –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É
- Auto-delete –æ—á–µ—Ä–µ–¥–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç —Ä–µ—Å—É—Ä—Å—ã

### ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å
- Frontend –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ specific types:
  - `user.{userId}.messageupdate` - —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  - `user.{userId}.dialogupdate` - —Ç–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥–∏
  - `user.{userId}.*` - –≤—Å–µ updates

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Worker
- Batch processing –≤ Worker
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ MongoDB

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

**–®–∞–≥–∏:**
1. User 1 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å `user_usr_xxx`
2. User 2 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å `user_usr_yyy`
3. User 1 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
4. Chat3 —Å–æ–∑–¥–∞–µ—Ç Event `message.create`
5. Update Worker —Å–æ–∑–¥–∞–µ—Ç Updates –¥–ª—è User1 –∏ User2
6. Updates –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ `chat3_updates`
7. User1 –ø–æ–ª—É—á–∞–µ—Ç update —á–µ—Ä–µ–∑ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å
8. User2 –ø–æ–ª—É—á–∞–µ—Ç update —á–µ—Ä–µ–∑ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å
9. Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ User2 –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø—Ä—è–º—ã—Ö Socket.io –∫–æ–º–Ω–∞—Ç
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ RabbitMQ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ WebSocket —Å–µ—Ä–≤–µ—Ä—ã

**–®–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 backend instance
2. User1 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Server1
3. User2 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Server2
4. User1 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
5. User2 –ø–æ–ª—É—á–∞–µ—Ç update —á–µ—Ä–µ–∑ RabbitMQ

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ Update –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## Migration Plan

### –û—Ç–∫–∞—Ç –Ω–∞ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–æ—Å—Ç—ã–ª—å:

```javascript
// –í routes/messages.js
const io = req.app.get('io');
if (io && io.emitNewMessage) {
  io.emitNewMessage(dialogId, result.data);
}
```

### Feature Flag

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å:

```javascript
// config/index.js
const USE_RABBITMQ_UPDATES = process.env.USE_RABBITMQ_UPDATES === 'true';

// –í websocket/index.js
if (USE_RABBITMQ_UPDATES) {
  // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ RabbitMQ
} else {
  // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ Socket.io rooms
}
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### RabbitMQ Management UI

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl -u rmuser:rmpassword http://localhost:15672/api/queues

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å bindings
curl -u rmuser:rmpassword http://localhost:15672/api/bindings
```

### Backend –ª–æ–≥–∏

```javascript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏
console.log(`üì¨ Created queue for user: ${userId}`);

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ update
console.log(`üì® Received update for ${userId}:`, update.eventType);

// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–µ–∑ WebSocket
console.log(`‚û°Ô∏è  Sent update to client: ${userId}`);
```

### Frontend –ª–æ–≥–∏

```typescript
// –í websocket.ts
console.log('üì¨ Received update:', update.eventType, update.data);
```

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: Chat3 Update Worker –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞:** Updates –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å Worker
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Chat3
- –ó–∞–ø—É—Å—Ç–∏—Ç—å Worker –≤—Ä—É—á–Ω—É—é

### –†–∏—Å–∫ 2: RabbitMQ connection lost

**–ü—Ä–æ–±–ª–µ–º–∞:** Updates –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å reconnection logic
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏

### –†–∏—Å–∫ 3: –û—á–µ—Ä–µ–¥–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `autoDelete: true`
- –î–æ–±–∞–≤–∏—Ç—å cleanup –ø—Ä–∏ shutdown
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–µ—Ä–µ–¥–µ–π

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `services/rabbitmqConsumer.js`
2. ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `websocket/index.js`
3. ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `services/websocket.ts` (frontend)
4. ‚úÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (–∫–æ—Å—Ç—ã–ª—å)
5. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
6. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **[UPDATES.md](chat3/UPDATES.md)** - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Updates –æ—Ç Chat3
- **[RABBITMQ_INTEGRATION.md](../backend/docs/RABBITMQ_INTEGRATION.md)** - RabbitMQ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **[REALTIME_FIX.md](REALTIME_FIX.md)** - –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∫–æ—Å—Ç—ã–ª—å)
- **[WEBSOCKET.md](../backend/WEBSOCKET.md)** - WebSocket API

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —á–µ—Ä–µ–∑ RabbitMQ –æ–±–µ—Å–ø–µ—á–∏—Ç:

‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ WebSocket —Å–µ—Ä–≤–µ—Ä—ã  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ RabbitMQ  
‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - –º–µ—Ç–∞-—Ç–µ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞  
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ specific update types  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞  

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-11-05

