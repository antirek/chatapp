# ๐ค Bot Worker

ะกะธััะตะผะฐ ะฑะพัะพะฒ ะดะปั ัะฐั-ะฟัะธะปะพะถะตะฝะธั. ะะพัั ะพะฑัะฐะฑะฐััะฒะฐัั ัะพะพะฑัะตะฝะธั ะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะฒะตัะฐัั ะฟะพะปัะทะพะฒะฐัะตะปัะผ.

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโ
โ   Chat3 API   โ  ะกะพะทะดะฐะฝะธะต ัะพะพะฑัะตะฝะธะน ะฒ ะดะธะฐะปะพะณะฐั ั ะฑะพัะฐะผะธ
โโโโโโโโฌโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ Update Workerโ  ะกะพะทะดะฐะฝะธะต Updates ะดะปั ะฑะพัะพะฒ (user.bot.bot_echo.*)
โโโโโโโโฌโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ   RabbitMQ   โ  Exchange: chat3_updates
โ   Updates    โ  Routing: user.bot.# (ะฒัะต ะฑะพัั)
โโโโโโโโฌโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ  Bot Worker  โ  ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ะดะปั ะฑะพัะพะฒ
โ  (ะพัะดะตะปัะฝัะน  โ  ะัะฟัะฐะฒะบะฐ ะพัะฒะตัะพะฒ ัะตัะตะท Chat3Client
โ   ะฟัะพัะตัั)   โ
โโโโโโโโโโโโโโโโ
```

## ะะพะผะฟะพะฝะตะฝัั

### 1. ะะพะดะตะปั Bot (`src/models/Bot.js`)

ะฅัะฐะฝะธั ะธะฝัะพัะผะฐัะธั ะพ ะฑะพัะฐั ะฒ MongoDB:

- `botId` - ัะฝะธะบะฐะปัะฝัะน ID ะฑะพัะฐ (ัะพัะผะฐั: `bot_XXXXXXXX`)
- `name` - ะธะผั ะฑะพัะฐ
- `type` - ัะธะฟ ะฑะพัะฐ (`system` ะธะปะธ `custom`)
- `handler` - ัะธะฟ ะพะฑัะฐะฑะพััะธะบะฐ (`echo`, `command`, `ai`)
- `isActive` - ะฐะบัะธะฒะตะฝ ะปะธ ะฑะพั

### 2. BotService (`src/services/BotService.js`)

ะัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ัะฐะฑะพัั ั ะฑะพัะฐะผะธ:

- ะะตะณะธัััะฐัะธั ะพะฑัะฐะฑะพััะธะบะพะฒ ะฑะพัะพะฒ
- ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน
- ะัะฟัะฐะฒะบะฐ ะพัะฒะตัะพะฒ ัะตัะตะท Chat3Client
- ะะฝะธัะธะฐะปะธะทะฐัะธั ัะธััะตะผะฝัั ะฑะพัะพะฒ

**ะะพัััะฟะฝัะต ะพะฑัะฐะฑะพััะธะบะธ:**

- **echo** - ััะพ-ะฑะพั, ะพัะฒะตัะฐะตั ัะตะผ ะถะต ัะตะบััะพะผ
- **command** - ะฑะพั ั ะบะพะผะฐะฝะดะฐะผะธ (`/help`, `/ping`, `/time`)

### 3. BotWorker (`src/workers/botWorker.js`)

ะะพัะบะตั ะดะปั ะพะฑัะฐะฑะพัะบะธ ัะพะพะฑัะตะฝะธะน ะฑะพัะพะฒ:

- ะะพะดะบะปััะตะฝะธะต ะบ RabbitMQ
- ะะพะดะฟะธัะบะฐ ะฝะฐ updates ะดะปั ะฑะพัะพะฒ (`user.bot.#`)
- ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ัะตัะตะท BotService
- ะัะฟัะฐะฒะบะฐ ะพัะฒะตัะพะฒ

### 4. ะะฐะฟััะบ (`src/workers/botStart.js`)

ะขะพัะบะฐ ะฒัะพะดะฐ ะดะปั ะทะฐะฟััะบะฐ bot worker ะบะฐะบ ะพัะดะตะปัะฝะพะณะพ ะฟัะพัะตััะฐ.

## ะะฐะฟััะบ

### Development (ั hot-reload)

```bash
cd backend
npm run bot:worker
```

### Production

```bash
cd backend
npm run bot:start
```

## ะกะธััะตะผะฝัะต ะฑะพัั

### bot_echo

**ID:** `bot_echo`  
**ะขะธะฟ:** `system`  
**ะะฑัะฐะฑะพััะธะบ:** `echo`  
**ะะฟะธัะฐะฝะธะต:** ะญัะพ-ะฑะพั, ะพัะฒะตัะฐะตั ัะตะผ ะถะต ัะตะบััะพะผ, ััะพ ะฟะพะปััะธะป

**ะะฒัะพะผะฐัะธัะตัะบะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั:**
ะัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต Bot Worker ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะตั `bot_echo` ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั, ะตัะปะธ ะตะณะพ ะตัะต ะฝะตั.

## ะะพะฑะฐะฒะปะตะฝะธะต ะฑะพัะฐ ะฒ ะดะธะฐะปะพะณ

ะะพั ะดะพะปะถะตะฝ ะฑััั ะดะพะฑะฐะฒะปะตะฝ ะฒ ะดะธะฐะปะพะณ ะบะฐะบ ะพะฑััะฝัะน ััะฐััะฝะธะบ ัะตัะตะท Chat3 API:

```bash
# ะะพะฑะฐะฒะธัั bot_echo ะฒ ะดะธะฐะปะพะณ
curl -X POST http://localhost:3000/api/dialogs/{dialogId}/members/bot_echo/add \
  -H "x-api-key: <YOUR_API_KEY>"
```

ะะปะธ ัะตัะตะท Chat3Client:

```javascript
await Chat3Client.addDialogMember(dialogId, 'bot_echo');
```

## ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. **ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต** ะฒ ะดะธะฐะปะพะณ, ะณะดะต ะตััั ะฑะพั
2. **Chat3 API** ัะพััะฐะฝัะตั ัะพะพะฑัะตะฝะธะต ะธ ัะพะทะดะฐะตั Event
3. **Update Worker** ัะพะทะดะฐะตั Updates ะดะปั ะฒัะตั ััะฐััะฝะธะบะพะฒ, ะฒะบะปััะฐั ะฑะพัะฐ
4. **RabbitMQ** ะฟัะฑะปะธะบัะตั Update ั routing key `user.bot.bot_echo.messageupdate`
5. **Bot Worker** ะฟะพะปััะฐะตั Update ัะตัะตะท ะฟะพะดะฟะธัะบั ะฝะฐ `user.bot.#`
6. **BotService** ะพะฑัะฐะฑะฐััะฒะฐะตั ัะพะพะฑัะตะฝะธะต ัะตัะตะท ัะพะพัะฒะตัััะฒัััะธะน handler
7. **Chat3Client** ะพัะฟัะฐะฒะปัะตั ะพัะฒะตั ะพั ะธะผะตะฝะธ ะฑะพัะฐ
8. **ะัะฒะตั** ะฟัะพัะพะดะธั ัะตัะตะท ะพะฑััะฝัะน ะฟะพัะพะบ Chat3 โ RabbitMQ โ WebSocket โ ะะปะธะตะฝั

## ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ ะฑะพัะฐ

### 1. ะกะพะทะดะฐัั ะทะฐะฟะธัั ะฒ MongoDB

```javascript
import Bot from './models/Bot.js';

const newBot = new Bot({
  botId: 'bot_mybot', // ะธะปะธ ะพััะฐะฒะธัั ะฟััััะผ ะดะปั ะฐะฒัะพะณะตะฝะตัะฐัะธะธ
  name: 'My Bot',
  type: 'custom',
  handler: 'echo', // ะธะปะธ 'command', 'ai'
  isActive: true,
});

await newBot.save();
```

### 2. ะะพะฑะฐะฒะธัั ะพะฑัะฐะฑะพััะธะบ (ะตัะปะธ ะฝัะถะตะฝ ะฝะพะฒัะน ัะธะฟ)

ะ `BotService.js`:

```javascript
this.botHandlers.set('myhandler', async (bot, message, dialogId) => {
  // ะะฐัะฐ ะปะพะณะธะบะฐ ะพะฑัะฐะฑะพัะบะธ
  return {
    content: 'Response text',
    type: 'internal.text',
    meta: { botResponse: true },
  };
});
```

### 3. ะะพะฑะฐะฒะธัั ะฑะพัะฐ ะฒ ะดะธะฐะปะพะณ

ะงะตัะตะท Chat3 API ะธะปะธ Chat3Client.

## ะะพะฝะธัะพัะธะฝะณ

### ะะพะณะธ

```bash
# ะะพะณะธ bot worker
tail -f logs/bot-worker.log

# ะะปะธ ะฒ ะบะพะฝัะพะปะธ ะฟัะธ ะทะฐะฟััะบะต
npm run bot:worker
```

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ

Bot Worker ะฒัะฒะพะดะธั ะฒ ะบะพะฝัะพะปั:
- โ ะะพะดะบะปััะตะฝะธะต ะบ MongoDB
- โ ะะฝะธัะธะฐะปะธะทะฐัะธั ัะธััะตะผะฝัั ะฑะพัะพะฒ
- โ ะะพะดะบะปััะตะฝะธะต ะบ RabbitMQ
- โ ะกะพะทะดะฐะฝะธะต ะพัะตัะตะดะธ
- ๐จ ะะพะปััะตะฝะฝัะต ัะพะพะฑัะตะฝะธั
- โ ะัะฟัะฐะฒะปะตะฝะฝัะต ะพัะฒะตัั

## ะะณัะฐะฝะธัะตะฝะธั

- ะะพั ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ ัะพะพะฑัะตะฝะธั ะพั ะดััะณะธั ะฑะพัะพะฒ (ะธะทะฑะตะณะฐะตั ัะธะบะปะพะฒ)
- ะะดะฝะพ ัะพะพะฑัะตะฝะธะต ะพะฑัะฐะฑะฐััะฒะฐะตััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท (ะทะฐัะธัะฐ ะพั ะดัะฑะปะธะบะฐัะพะฒ)
- ะะพั ะดะพะปะถะตะฝ ะฑััั ะฐะบัะธะฒะตะฝ (`isActive: true`) ะดะปั ะพะฑัะฐะฑะพัะบะธ ัะพะพะฑัะตะฝะธะน

## Troubleshooting

### ะะพั ะฝะต ะพัะฒะตัะฐะตั

1. ะัะพะฒะตัะธัั, ััะพ Bot Worker ะทะฐะฟััะตะฝ: `npm run bot:worker`
2. ะัะพะฒะตัะธัั, ััะพ ะฑะพั ะฐะบัะธะฒะตะฝ ะฒ ะฑะฐะทะต: `db.bots.findOne({ botId: 'bot_echo' })`
3. ะัะพะฒะตัะธัั, ััะพ ะฑะพั ะดะพะฑะฐะฒะปะตะฝ ะฒ ะดะธะฐะปะพะณ ะบะฐะบ ััะฐััะฝะธะบ
4. ะัะพะฒะตัะธัั ะปะพะณะธ Bot Worker ะฝะฐ ะพัะธะฑะบะธ
5. ะัะพะฒะตัะธัั RabbitMQ ะพัะตัะตะดั: `chatpapp_bot_worker`

### ะัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั

- ะัะพะฒะตัะธัั MongoDB ะฟะพะดะบะปััะตะฝะธะต
- ะัะพะฒะตัะธัั RabbitMQ ะฟะพะดะบะปััะตะฝะธะต
- ะัะพะฒะตัะธัั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฒ `.env`

## ะะฐััะธัะตะฝะธะต ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ

### ะะพะฑะฐะฒะปะตะฝะธะต ะบะพะผะฐะฝะด

ะ `BotService.js`, handler `command`:

```javascript
case 'mycommand':
  return {
    content: 'Command response',
    type: 'internal.text',
    meta: { botResponse: true },
  };
```

### ะะฝัะตะณัะฐัะธั ั AI

ะกะพะทะดะฐัั ะฝะพะฒัะน handler `ai`:

```javascript
this.botHandlers.set('ai', async (bot, message, dialogId) => {
  // ะัะทะพะฒ AI API
  const aiResponse = await callAI(message.content);
  return {
    content: aiResponse,
    type: 'internal.text',
    meta: { botResponse: true },
  };
});
```

