# Команды для ботов в групповых чатах

## Проблема

В групповом чате может быть несколько ботов. Пользователь хочет отправить команду конкретному боту. Нужен универсальный текстовый формат команд типа `/command`.

## Варианты выбора бота для команды

### 1. Префикс с именем бота: `/бот:команда`

**Формат:**
```
/echo:привет
/weather:погода Москва
/translator:translate hello to russian
```

**Плюсы:**
- Явно указывается, какому боту команда адресована
- Универсальный формат
- Нет конфликтов между ботами

**Минусы:**
- Нужно знать имя бота
- Более длинный формат

### 2. Выбор бота через UI перед командой

**Механизм:**
- В поле ввода кнопка/выпадающий список "Выбрать бота"
- После выбора бота в поле появляется префикс `/echo:` или `@Echo:`
- Затем вводится команда

**Плюсы:**
- Не нужно помнить имена ботов
- Визуально понятно, какому боту команда

**Минусы:**
- Дополнительный UI элемент
- Больше действий для пользователя

### 3. Автодополнение при вводе `/`

**Механизм:**
- При вводе `/` показывается список доступных ботов и их команд
- Выбор бота → показываются его команды → выбор команды
- Или ввод `/бот` → автодополнение команд этого бота

**Плюсы:**
- Удобно для пользователя
- Видно доступные команды
- Не нужно помнить точный синтаксис

**Минусы:**
- Более сложная реализация
- Нужна система регистрации команд ботов

### 4. Универсальный `/команда` с автоматическим определением

**Механизм:**
- Команда уникальна (например, `/weather` только у WeatherBot)
- Если команда есть у нескольких ботов → показывается выбор бота
- Если команда уникальна → автоматически определяется бот

**Плюсы:**
- Короткий формат
- Не нужно указывать бота явно
- Интуитивно понятно

**Минусы:**
- Возможны конфликты команд между ботами
- Нужна система регистрации и разрешения конфликтов

## Рекомендуемый подход: Гибридный

**Формат: `/бот:команда` или `/команда`**

### Правила работы:

1. **Если команда уникальна** → `/команда` (автоматически определяется бот)
2. **Если команда есть у нескольких ботов** → `/команда` показывает выбор бота
3. **Явное указание** → `/бот:команда` всегда работает

### UI поддержка:

- При вводе `/` показывается список ботов и их команд
- Автодополнение: `/echo` → подсказка `/echo:текст`
- Визуальная индикация: команды выделяются в чате (например, другой цвет/иконка)

### Примеры:

```
/echo:привет          → явно боту Echo
/weather:Москва       → явно WeatherBot
/help                 → если команда уникальна, автоматически
/translate:hello      → если только один переводчик, автоматически
```

## Визуальное представление в чате

### Варианты отображения команд:

1. **Упоминание с префиксом `@`**
   ```
   @Echo привет
   @WeatherBot погода в Москве
   ```
   - Плюсы: привычно (как в Telegram/Slack), понятно какой бот адресат
   - Минусы: нужно парсить текст, возможны ложные срабатывания

2. **Специальный тип сообщения (command)**
   - Отдельная кнопка/иконка для команд
   - При выборе бота открывается список его команд
   - Сообщение визуально отличается (например, другой цвет/иконка)
   - Плюсы: явное разделение команд и обычных сообщений, структурированный ввод
   - Минусы: дополнительный UI, больше кликов

3. **Слэш-команды** (рекомендуется)
   ```
   /echo:привет
   /weather Москва
   ```
   - Плюсы: стандартный паттерн, легко парсить
   - Минусы: нужно указывать имя команды/бота

## Как это работает

### Обработка на фронтенде:

1. **Парсинг при вводе:**
   - Если начинается с `/`, показывать автодополнение ботов и команд
   - Валидация формата команды
   - Подсветка команды в поле ввода

2. **Визуальная индикация:**
   - Команды выделяются в чате (например, серый фон, иконка команды)
   - `@бот` или `/бот:команда` подсвечивается

3. **Отправка:**
   - Сообщение помечается как команда (`type: 'command'`, `targetBotId`)
   - Определяется бот-получатель

### Обработка на бэкенде:

1. **RabbitMQ:**
   - Бот получает сообщение только если оно адресовано ему
   - Routing: сообщения с `targetBotId` идут в очередь конкретного бота

2. **Парсинг:**
   - Бот парсит команду и выполняет действие
   - Валидация команды на стороне бота

3. **Ответ:**
   - Бот отправляет ответ как обычное сообщение
   - Возможно связывание ответа с командой через `quotedMessage` или `replyTo`

### Визуализация в чате:

- **Команды:** особый стиль (например, серый фон, иконка команды)
- **Ответы ботов:** обычные сообщения, но с пометкой, что это ответ на команду
- **Цепочка:** команда → ответ бота визуально связаны (например, через цитирование)

## Вопросы для уточнения

1. **Приватность команд:**
   - Команды видны всем участникам или только отправителю и боту?

2. **История команд:**
   - Нужна ли история команд (список доступных команд бота)?
   - Команда `/help` показывает команды?

3. **Параметры команд:**
   - Поддержка параметров команд (например, `/weather Москва, завтра`)?
   - Как парсить сложные параметры?

4. **Индикация выполнения:**
   - Нужна ли индикация выполнения команды (бот печатает, обрабатывает)?
   - Таймаут выполнения команды?

5. **Обработка ошибок:**
   - Что если бот не распознал команду?
   - Что если бот недоступен?
   - Как показывать ошибки пользователю?

6. **Конфликты команд:**
   - Как обрабатывать, если несколько ботов имеют команду `/help`?
   - Приоритет ботов?

7. **Валидация:**
   - Нужна ли валидация команд на фронтенде перед отправкой?
   - Проверка доступности команды у бота?

## Статус

**Статус:** Обсуждение, не реализовано

**Дата:** 2025-01-XX

**Примечание:** Требуется уточнение требований перед реализацией

