# Упоминания (Mentions) в чатах

## Концепция

Возможность упомянуть участника диалога в сообщении через `@username`, чтобы привлечь его внимание и уведомить о сообщении.

## Варианты использования

### 1. Привлечение внимания
- **Сценарий:** В групповом чате нужно обратиться к конкретному участнику
- **Пример:** "@Иван, можешь помочь с задачей?"
- **Цель:** Участник получает уведомление о том, что его упомянули

### 2. Ответ на конкретное сообщение
- **Сценарий:** Ответить конкретному участнику в групповом обсуждении
- **Пример:** "@Мария, согласен с твоим предложением"
- **Цель:** Понятно, кому адресован ответ

### 3. Координация в группе
- **Сценарий:** Назначение задач или делегирование в рабочей группе
- **Пример:** "@Петр, проверь этот код" или "@Анна и @Борис, подготовьте презентацию"
- **Цель:** Чёткое указание ответственных

### 4. Уведомление о важной информации
- **Сценарий:** Сообщение важной информации с упоминанием ключевых участников
- **Пример:** "@Все, встреча переносится на завтра"
- **Цель:** Гарантировать, что важные участники увидят сообщение

### 5. Обсуждение с несколькими участниками
- **Сценарий:** Вовлечение нескольких участников в обсуждение
- **Пример:** "@Иван @Мария @Петр, что думаете о новом дизайне?"
- **Цель:** Начать обсуждение с конкретными участниками

### 6. Упоминание ботов
- **Сценарий:** Вызов бота для выполнения команды
- **Пример:** "@WeatherBot погода в Москве" или "@Echo повтори это"
- **Цель:** Активация функциональности бота

### 7. Упоминание в контексте
- **Сценарий:** Упоминание участника в связи с конкретной темой
- **Пример:** "Как @Иван предложил, давайте сделаем так"
- **Цель:** Ссылка на предыдущее обсуждение или идею

## Варианты реализации

### 1. Простое упоминание `@username`

**Формат:**
```
@Иван привет, как дела?
@Мария, можешь помочь?
@Петр @Анна, встреча в 15:00
```

**Механизм:**
- При вводе `@` показывается список участников диалога
- Выбор участника → автодополнение `@username`
- При отправке сообщения упомянутые участники получают уведомление

**Визуально:**
- `@username` подсвечивается в сообщении (например, синим цветом)
- Клик по упоминанию → переход к профилю участника или открытие контекстного меню

**Плюсы:**
- Простой и интуитивный формат
- Стандартный паттерн (Telegram, Slack, Discord)
- Легко парсить

**Минусы:**
- Нужно знать username или имя участника
- Возможны опечатки

### 2. Упоминание с автодополнением

**Механизм:**
- При вводе `@` показывается выпадающий список участников
- Фильтрация по мере ввода: `@И` → показываются участники на "И"
- Выбор из списка → автодополнение полного имени
- Поддержка поиска по имени или username

**Визуально:**
- Выпадающий список с аватарами и именами
- Подсветка выбранного элемента
- Группировка: пользователи, боты, контакты

**Плюсы:**
- Не нужно помнить точные имена
- Удобный поиск участников
- Меньше опечаток

**Минусы:**
- Требует реализации автодополнения
- Нужен список участников в памяти

### 3. Упоминание через контекстное меню

**Механизм:**
- Клик по участнику в списке участников → "Упомянуть"
- Или клик по сообщению участника → "Ответить и упомянуть"
- В поле ввода появляется `@username:`

**Визуально:**
- Аналогично варианту 1

**Плюсы:**
- Не нужно вводить имя вручную
- Интуитивно понятно

**Минусы:**
- Дополнительные действия
- Нужно открывать список участников

### 4. Умное упоминание (Smart Mentions)

**Механизм:**
- Автоматическое определение контекста упоминания
- При вводе `@` показываются:
  - Недавно упомянутые участники
  - Активные участники
  - Участники, связанные с текущей темой
- Поддержка групповых упоминаний: `@все`, `@админы`, `@модераторы`

**Визуально:**
- Приоритизированный список участников
- Группы участников как отдельные опции

**Плюсы:**
- Удобно для больших групп
- Быстрый доступ к часто используемым упоминаниям

**Минусы:**
- Сложнее реализация
- Нужна система группировки участников

### 5. Упоминание с типом

**Формат:**
```
@Иван:привет
@Иван/here:важное сообщение
@Иван/urgent:срочно!
```

**Механизм:**
- Базовое упоминание: `@username`
- Модификаторы: `/here` (здесь), `/urgent` (срочно), `/important` (важно)
- Разные типы уведомлений для получателя

**Визуально:**
- Разные цвета/иконки для разных типов упоминаний
- Визуальная индикация важности

**Плюсы:**
- Гибкость в уведомлениях
- Можно указать важность сообщения

**Минусы:**
- Может быть сложно для пользователей
- Нужно запоминать модификаторы

## Визуальное представление в чате

### В поле ввода:

**Вариант 1: Подсветка упоминания**
- `@username` подсвечивается синим цветом при вводе
- Выпадающий список с участниками при вводе `@`

**Вариант 2: Чипсы (Chips)**
- Упоминания отображаются как отдельные элементы (чипсы)
- Можно удалить упоминание кликом на крестик
- Визуально отделены от текста

**Вариант 3: Инлайн-подсказки**
- При вводе `@` показывается подсказка с доступными участниками
- Автодополнение с подсветкой

### В сообщении:

**Вариант 1: Подсветка текста**
- `@username` выделяется синим/фиолетовым цветом
- Кликабельно → переход к профилю
- Подчёркивание при наведении

**Вариант 2: Чипсы в сообщении**
- Упоминания отображаются как отдельные элементы
- Аватар участника рядом с именем
- Клик → профиль участника

**Вариант 3: Комбинированный**
- Упоминания подсвечиваются
- При наведении показывается превью профиля
- Клик → полный профиль

### Уведомления:

**Вариант 1: Обычное уведомление**
- "Вас упомянули в сообщении"
- Показывается имя отправителя и диалог

**Вариант 2: Уведомление с контекстом**
- "Иван упомянул вас в группе 'Рабочая группа'"
- Показывается фрагмент сообщения
- Прямая ссылка на сообщение

**Вариант 3: Типизированные уведомления**
- Разные типы уведомлений для разных типов упоминаний
- Визуальная индикация важности

## Технические аспекты

### Парсинг упоминаний:

**Вариант 1: Регулярные выражения**
- Парсинг `@username` через regex
- Извлечение всех упоминаний из текста
- Валидация существования участников

**Вариант 2: Структурированные данные**
- Упоминания хранятся отдельно от текста
- Поле `mentions: [{userId, name, position}]`
- Текст с плейсхолдерами для упоминаний

**Вариант 3: Markdown-подобный формат**
- Использование формата типа `[@username](userId)`
- Парсинг при отображении
- Сохранение исходного формата

### Хранение:

**Вариант 1: В тексте сообщения**
- Упоминания хранятся как часть текста
- Парсинг при отображении
- Дополнительное поле `mentionedUserIds: []` для быстрого поиска

**Вариант 2: Отдельное поле**
- Поле `mentions: [{userId, name, position}]`
- Текст без упоминаний или с плейсхолдерами
- Быстрый доступ к упомянутым участникам

**Вариант 3: Гибридный**
- Упоминания в тексте для отображения
- Отдельное поле для индексации и поиска

### Доставка уведомлений:

**Вариант 1: RabbitMQ с фильтрацией**
- Сообщение отправляется через RabbitMQ
- Отдельные уведомления для каждого упомянутого участника
- Routing key включает `userId`

**Вариант 2: WebSocket с фильтрацией**
- Сообщение отправляется через WebSocket
- Сервер определяет упомянутых участников
- Отдельные события для упомянутых участников

**Вариант 3: Отдельный канал уведомлений**
- Упоминания обрабатываются отдельно
- Специальный тип уведомления "mention"
- Приоритетная доставка

### Индексация и поиск:

1. **Поиск по упоминаниям:**
   - Фильтр "Сообщения, где меня упомянули"
   - Поиск по упомянутым участникам
   - История упоминаний

2. **Статистика:**
   - Количество упоминаний участника
   - Самые упоминаемые участники
   - Активность упоминаний

3. **Уведомления:**
   - Настройки уведомлений для упоминаний
   - Фильтрация упоминаний (только от определённых участников)
   - Группировка уведомлений

## Вопросы для уточнения

### Функциональность:

1. **Множественные упоминания:**
   - Можно ли упомянуть несколько участников в одном сообщении?
   - Формат: `@Иван @Мария @Петр`?

2. **Групповые упоминания:**
   - Поддержка `@все`, `@админы`, `@модераторы`?
   - Как определять группы участников?

3. **Упоминание ботов:**
   - Упоминание бота = команда боту?
   - Или упоминание и команда разделены?

4. **Упоминание в ответе:**
   - Автоматическое упоминание при ответе на сообщение?
   - Опциональное или обязательное?

5. **Упоминание неактивных участников:**
   - Можно ли упомянуть участника, который покинул группу?
   - Что если участник заблокирован?

6. **Упоминание в личных сообщениях:**
   - Нужны ли упоминания в p2p диалогах?
   - Или только в групповых?

### UX/UI:

1. **Автодополнение:**
   - Какой формат автодополнения удобнее?
   - Показывать аватары в списке?
   - Группировка: пользователи, боты, контакты?

2. **Визуализация:**
   - Как визуально отличать упоминания от обычного текста?
   - Нужна ли анимация при упоминании?

3. **Уведомления:**
   - Как уведомлять о упоминаниях?
   - Отдельный тип уведомления?
   - Настройки уведомлений для упоминаний?

4. **Поиск:**
   - Нужен ли фильтр "Сообщения, где меня упомянули"?
   - Поиск по упомянутым участникам?

5. **История:**
   - Показывать историю упоминаний участника?
   - Статистика упоминаний?

### Технические:

1. **Производительность:**
   - Как обрабатывать упоминания в больших группах (100+ участников)?
   - Кэширование списка участников?

2. **Валидация:**
   - Проверка существования участника при вводе?
   - Что если участник покинул группу до отправки?

3. **Синхронизация:**
   - Как синхронизировать упоминания между устройствами?
   - Офлайн-режим для упоминаний?

4. **Безопасность:**
   - Можно ли упомянуть участника, который заблокировал отправителя?
   - Ограничения на упоминания (спам-защита)?

## Рекомендации

### Рекомендуемый подход:

**Формат: `@username` с автодополнением**

1. **Ввод:**
   - При вводе `@` показывается выпадающий список участников
   - Фильтрация по мере ввода
   - Выбор участника → автодополнение `@username`
   - Поддержка множественных упоминаний: `@Иван @Мария`

2. **Визуализация:**
   - `@username` подсвечивается синим цветом в сообщении
   - Кликабельно → переход к профилю участника
   - В поле ввода: подсветка при вводе

3. **Хранение:**
   - Упоминания в тексте для отображения
   - Дополнительное поле `mentionedUserIds: []` для индексации
   - Позиции упоминаний для точного отображения

4. **Уведомления:**
   - Отдельный тип уведомления "mention"
   - Показывается имя отправителя, диалог и фрагмент сообщения
   - Прямая ссылка на сообщение

5. **Дополнительные функции:**
   - Фильтр "Сообщения, где меня упомянули"
   - Автоматическое упоминание при ответе на сообщение (опционально)
   - Поддержка групповых упоминаний: `@все` (для админов)

### Упрощённый вариант:

**Базовое упоминание без автодополнения**

- Формат: `@username` в тексте
- Парсинг при отправке
- Подсветка в сообщении
- Базовые уведомления
- Минимальные изменения в UI

## Статус

**Статус:** Обсуждение, не реализовано

**Дата:** 2025-01-XX

**Примечание:** Требуется уточнение требований перед реализацией

